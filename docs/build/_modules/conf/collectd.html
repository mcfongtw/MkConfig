<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>conf.collectd &#8212; MkConfig 0.1-alpha documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1-alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MkConfig 0.1-alpha documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for conf.collectd</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">core.chain</span> <span class="k">import</span> <span class="n">ContextAwareTransfiguration</span>
<span class="kn">from</span> <span class="nn">core.factory</span> <span class="k">import</span> <span class="n">TemplateEngineFactory</span>
<span class="kn">from</span> <span class="nn">core.jinja2</span> <span class="k">import</span> <span class="n">Jinja2Engine</span>
<span class="kn">from</span> <span class="nn">conf.context</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">env</span> <span class="k">import</span> <span class="n">Configurations</span>
<span class="kn">from</span> <span class="nn">core.chain</span> <span class="k">import</span> <span class="n">ChainOfTransfiguration</span>
<span class="kn">from</span> <span class="nn">conf.utils</span> <span class="k">import</span> <span class="n">Utils</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">listdir</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">join</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">env</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1">#TODO: Move all common transifiguration classes to chain.py</span>

<div class="viewcode-block" id="PrepareAppConfTransfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.PrepareAppConfTransfiguration">[docs]</a><span class="k">class</span> <span class="nc">PrepareAppConfTransfiguration</span><span class="p">(</span><span class="n">ContextAwareTransfiguration</span><span class="p">):</span>

<div class="viewcode-block" id="PrepareAppConfTransfiguration.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.PrepareAppConfTransfiguration.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">appName</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_APP_PREFIX</span><span class="p">]</span>

        <span class="n">appPropertiesYamlFileName</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_APP_CONF_DIR</span><span class="p">]</span> <span class="o">+</span> <span class="n">appName</span> <span class="o">+</span> <span class="s1">&#39;.properties.yaml&#39;</span>
        <span class="n">PrepareAppConfTransfiguration</span><span class="o">.</span><span class="n">validate_file_exist</span><span class="p">(</span><span class="n">appPropertiesYamlFileName</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_YAML_PROPS_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="n">appPropertiesYamlFileName</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Register the yaml file for app [</span><span class="si">{0}</span><span class="s1">] at [</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">appPropertiesYamlFileName</span><span class="p">))</span>

        <span class="n">appMbeansYamlFileName</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_APP_CONF_DIR</span><span class="p">]</span> <span class="o">+</span> <span class="n">appName</span> <span class="o">+</span> <span class="s1">&#39;.mbeans.yaml&#39;</span>
        <span class="n">PrepareAppConfTransfiguration</span><span class="o">.</span><span class="n">validate_file_exist</span><span class="p">(</span><span class="n">appMbeansYamlFileName</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_YAML_MBEANS_FILE</span><span class="p">]</span> <span class="o">=</span> <span class="n">appMbeansYamlFileName</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Register the mbean file for app [</span><span class="si">{0}</span><span class="s1">] at [</span><span class="si">{1}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">appName</span><span class="p">,</span> <span class="n">appMbeansYamlFileName</span><span class="p">))</span></div>


    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="PrepareAppConfTransfiguration.validate_file_exist"><a class="viewcode-back" href="../../code.html#conf.collectd.PrepareAppConfTransfiguration.validate_file_exist">[docs]</a>    <span class="k">def</span> <span class="nf">validate_file_exist</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;File [</span><span class="si">{0}</span><span class="s1">] not found !&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span></div></div>

<span class="c1">#TODO: Create a InMemoryTemplateTransfiguration</span>

<span class="c1">#TODO: Rename to FileTemplateTransfiguration</span>
<div class="viewcode-block" id="CollectdJmxTransfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxTransfiguration">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxTransfiguration</span><span class="p">(</span><span class="n">ContextAwareTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ContextAwareTransfiguration that transform with respect to collectd-jmx template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_input</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_output</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">TemplateEngineFactory</span><span class="o">.</span><span class="n">createEngine</span><span class="p">(</span><span class="n">Jinja2Engine</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<div class="viewcode-block" id="CollectdJmxTransfiguration.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxTransfiguration.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="p">)</span></div></div>

<span class="c1">#TODO: Separate FileReaderToContextTransfiguration, and make YamlFileReaderToContextTransfiguration to inherit from</span>
<div class="viewcode-block" id="YamlToContextTransfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.YamlToContextTransfiguration">[docs]</a><span class="k">class</span> <span class="nc">YamlToContextTransfiguration</span><span class="p">(</span><span class="n">ContextAwareTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A ContextAwareTransfiguration that reads data from yaml file path from context and persists result back in context</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_key_file_path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyName</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key_file_path</span> <span class="o">=</span> <span class="n">keyName</span>

<div class="viewcode-block" id="YamlToContextTransfiguration.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.YamlToContextTransfiguration.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_file_path</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;I/O error[</span><span class="si">{0}</span><span class="s2">] at [</span><span class="si">{1}</span><span class="s2">]: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">strerror</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yaml_content</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">yaml_content</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">context</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="CollectdJmxPropertiesToContextTransfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxPropertiesToContextTransfiguration">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxPropertiesToContextTransfiguration</span><span class="p">(</span><span class="n">YamlToContextTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A YamlToContextTransfiguration that reads yaml file with respect to attr : _collectd_jmx_yaml_props_file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyName</span> <span class="o">=</span> <span class="n">CTX_KEY_COLLECTD_JMX_YAML_PROPS_FILE</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">keyName</span><span class="p">)</span></div>


<div class="viewcode-block" id="CollectdJmxMbeansToContextTransfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxMbeansToContextTransfiguration">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxMbeansToContextTransfiguration</span><span class="p">(</span><span class="n">YamlToContextTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A YamlToContextTransfiguration that reads yaml file with respect to attr : _collectd_jmx_yaml_mbeans_file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyName</span> <span class="o">=</span> <span class="n">CTX_KEY_COLLECTD_JMX_YAML_MBEANS_FILE</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">keyName</span><span class="p">)</span>

<div class="viewcode-block" id="CollectdJmxMbeansToContextTransfiguration.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxMbeansToContextTransfiguration.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1">#FIXME: resolve this inheritance issue</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Transfiguration performing :[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_file_path</span><span class="p">]</span>
        <span class="n">mbeans</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;I/O error[</span><span class="si">{0}</span><span class="s2">] at [</span><span class="si">{1}</span><span class="s2">]: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">strerror</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">raw_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">raw_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mbean</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patch_mbean_table_value</span><span class="p">(</span><span class="n">mbean</span><span class="p">)</span>
                    <span class="n">mbeans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mbean</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
                    <span class="n">mbeans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

            <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_MBEANS_SET</span><span class="p">]</span> <span class="o">=</span> <span class="n">mbeans</span></div>

<div class="viewcode-block" id="CollectdJmxMbeansToContextTransfiguration.patch_mbean_table_value"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxMbeansToContextTransfiguration.patch_mbean_table_value">[docs]</a>    <span class="k">def</span> <span class="nf">patch_mbean_table_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mbean</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">mbean</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;Table&#39;</span> <span class="ow">in</span> <span class="n">attribute</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;Table&#39;</span><span class="p">]</span>
                <span class="n">attribute</span><span class="p">[</span><span class="s1">&#39;Table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">boolean_to_lowercase_literal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">mbean</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CollectdJmxTransTemplateToStub"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxTransTemplateToStub">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxTransTemplateToStub</span><span class="p">(</span><span class="n">CollectdJmxTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The first phase of  CollectdJmxTransfiguration to transform from input yaml files to (half-product) configuration stub</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="CollectdJmxTransTemplateToStub.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxTransTemplateToStub.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_TEMPLATE_FILE</span><span class="p">]</span>
        <span class="n">intermediate_template</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">input</span> <span class="o">+</span> <span class="s1">&#39;.tmp&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="n">Configurations</span><span class="o">.</span><span class="n">getTemplateFile</span><span class="p">(</span><span class="n">intermediate_template</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CollectdJmxTransStubToConfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxTransStubToConfiguration">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxTransStubToConfiguration</span><span class="p">(</span><span class="n">CollectdJmxTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The second phase of CollectdJmxTransfiguration to transform from the stub file to a partial configuration for a specific appliation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="CollectdJmxTransStubToConfiguration.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxTransStubToConfiguration.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">intermediate_template</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_TEMPLATE_FILE</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tmp&#39;</span>

        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_APP_PREFIX</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.output.partial&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_input</span> <span class="o">=</span> <span class="n">intermediate_template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="n">Configurations</span><span class="o">.</span><span class="n">getOutputFile</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CollectdJmxPartialTransifgurationChain"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxPartialTransifgurationChain">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxPartialTransifgurationChain</span><span class="p">(</span><span class="n">ChainOfTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An (inner) chain of transfiguration that transform input to a partial collectd jmx configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">TemplateEngineFactory</span><span class="o">.</span><span class="n">addFactory</span><span class="p">(</span><span class="s1">&#39;Jinja2Engine&#39;</span><span class="p">,</span> <span class="n">Jinja2Engine</span><span class="o">.</span><span class="n">Factory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_step0</span> <span class="o">=</span> <span class="n">PrepareAppConfTransfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step1</span> <span class="o">=</span> <span class="n">CollectdJmxPropertiesToContextTransfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step2</span> <span class="o">=</span> <span class="n">CollectdJmxMbeansToContextTransfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step3</span> <span class="o">=</span> <span class="n">CollectdJmxTransTemplateToStub</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step4</span> <span class="o">=</span> <span class="n">CollectdJmxTransStubToConfiguration</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step4</span><span class="p">)</span></div>


<div class="viewcode-block" id="SplitAppConfTransfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.SplitAppConfTransfiguration">[docs]</a><span class="k">class</span> <span class="nc">SplitAppConfTransfiguration</span><span class="p">(</span><span class="n">ContextAwareTransfiguration</span><span class="p">):</span>

<div class="viewcode-block" id="SplitAppConfTransfiguration.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.SplitAppConfTransfiguration.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">listOfAppNames</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_USER_SELECTED_APP_LIST</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1">#FIXME: The distinguishment might not be necessary, as above always return a list of 0 or 1 element</span>
        <span class="c1">#distinguish between string object and list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">listOfAppNames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing ONE app [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="n">listOfAppNames</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generateAppPartialConfiguration</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">listOfAppNames</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing list of apps [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">listOfAppNames</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">appName</span> <span class="ow">in</span> <span class="n">listOfAppNames</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generateAppPartialConfiguration</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">appName</span><span class="p">)</span></div>

<div class="viewcode-block" id="SplitAppConfTransfiguration.generateAppPartialConfiguration"><a class="viewcode-back" href="../../code.html#conf.collectd.SplitAppConfTransfiguration.generateAppPartialConfiguration">[docs]</a>    <span class="k">def</span> <span class="nf">generateAppPartialConfiguration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">appName</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Spliting the partial configuraiton for [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">appName</span><span class="p">)</span>

        <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_APP_PREFIX</span><span class="p">]</span> <span class="o">=</span> <span class="n">appName</span>
        <span class="n">inner_chain</span> <span class="o">=</span> <span class="n">CollectdJmxPartialTransifgurationChain</span><span class="p">()</span>
        <span class="n">inner_chain</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CollectdJmxConsolidatePartialConfigurations"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxConsolidatePartialConfigurations">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxConsolidatePartialConfigurations</span><span class="p">(</span><span class="n">ContextAwareTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The final phase of CollectdJmxTransfiguration to consolidated a complete Collectd-Jmx configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="CollectdJmxConsolidatePartialConfigurations.perform"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxConsolidatePartialConfigurations.perform">[docs]</a>    <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">LoadPlugin java</span>

<span class="s2">&lt;Plugin &quot;java&quot;&gt;</span>
<span class="s2">    #JVMARG &quot;-verbose:jni&quot;</span>
<span class="s2">    JVMArg &quot;-Djava.class.path=/usr/share/collectd/java/collectd-api.jar:/usr/share/collectd/java/generic-jmx.jar&quot;</span>

<span class="s2">    LoadPlugin &quot;org.collectd.java.GenericJMX&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">footer</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>


<span class="s2">&lt;/Plugin&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span> <span class="o">+</span> <span class="n">header</span>
        <span class="n">partial_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">listOfAppNames</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_USER_SELECTED_APP_LIST</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># Retreive list of partial files based on user selected apps under output/</span>
        <span class="k">for</span> <span class="n">appName</span> <span class="ow">in</span> <span class="n">listOfAppNames</span> <span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">appName</span> <span class="o">+</span> <span class="s2">&quot;.output.partial&quot;</span>
            <span class="n">partial_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Configurations</span><span class="o">.</span><span class="n">getOutputFile</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>


        <span class="k">for</span> <span class="n">partial_file_path</span> <span class="ow">in</span> <span class="n">partial_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">partial_file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.partial&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">partial_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;I/O error[</span><span class="si">{0}</span><span class="s2">] at [</span><span class="si">{1}</span><span class="s2">]: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">partial_file_path</span><span class="p">,</span> <span class="n">strerror</span><span class="p">))</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">partial_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span> <span class="o">+</span> <span class="n">partial_content</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read partial content fromm [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">partial_file_path</span><span class="p">)</span>


        <span class="n">content</span> <span class="o">=</span> <span class="n">content</span> <span class="o">+</span><span class="n">footer</span>

        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">Configurations</span><span class="o">.</span><span class="n">getOutputFile</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="n">CTX_KEY_COLLECTD_JMX_FINAL_OUTPUT</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;I/O error[</span><span class="si">{0}</span><span class="s2">] at [</span><span class="si">{1}</span><span class="s2">]: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">strerror</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write whole content to [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">output_filename</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CollectdJmxTransfigurationChain"><a class="viewcode-back" href="../../code.html#conf.collectd.CollectdJmxTransfigurationChain">[docs]</a><span class="k">class</span> <span class="nc">CollectdJmxTransfigurationChain</span><span class="p">(</span><span class="n">ChainOfTransfiguration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An (outer) chain of transfiguration that consolidate all partial pieces to a complete collectd jmx configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_step0</span> <span class="o">=</span> <span class="n">SplitAppConfTransfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_step1</span> <span class="o">=</span> <span class="n">CollectdJmxConsolidatePartialConfigurations</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_step1</span><span class="p">)</span></div>




</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MkConfig 0.1-alpha documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Michael Fong.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>